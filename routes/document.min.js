var express=require("express"),router=express.Router();const fs=require("fs"),s3=require("s3-client"),s3_client=s3.createClient({s3Options:{region:"us-west-1",accessKeyId:process.env.aws_access_key_id,secretAccessKey:process.env.aws_secret_access_key}});router.post("/:document_id",function(e,n,s){const o=e.params.document_id;let t=JSON.parse(e.body);JSON.parse(t)&&(t=JSON.stringify(JSON.parse(t),null,2));const r=`documents/${o}.json`;fs.writeFile(r,t,function(e){if(e)return console.log(e);if("prod"===process.env.environment){const e={localFile:r,s3Params:{Bucket:"static.everything.io",Key:`permy.link/${r}`}},s=s3_client.uploadFile(e);s.on("error",function(e){n.status(500).send(e)}),s.on("end",function(){n.send(`Saved ${t} as ${o}.json`)})}else n.send(`Saved ${t} as ${o}.json`)})}),router.get("/:document_id/raw",function(e,n,s){const o=e.params.document_id,t=`documents/${o}.json`,r=()=>{fs.readFile(t,"utf8",(e,s)=>{if(e)return void console.error(e);n.setHeader("Content-Type","application/json");const o=JSON.stringify(JSON.parse(s),null,2);n.send(o)})};if("prod"===process.env.environment){const e=downloader_for_s3(t);e.on("error",e=>{console.log(e),n.status(500).send(e)}),e.on("end",r)}else r()}),router.get("/:document_id",function(e,n,s){const o=e.params.document_id,t=`documents/${o}.json`,r=()=>{fs.readFile(t,"utf8",(e,s)=>{if(e)return console.error(e),void n.status(500).send(e);try{n.send(s)}catch(e){n.status(500).send(e)}})};if("prod"===process.env.environment){const e=downloader_for_s3(t);e.on("error",e=>{console.log(e),n.status(500).send(e)}),e.on("end",r)}else r()});const downloader_for_s3=e=>{const n={localFile:e,s3Params:{Bucket:"static.everything.io",Key:`permy.link/${e}`}};return s3_client.downloadFile(n)};module.exports=router;