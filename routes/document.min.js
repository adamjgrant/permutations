var express=require("express"),router=express.Router();const fs=require("fs"),s3=require("s3-client"),s3_client=s3.createClient({s3Options:{region:"us-west-1",accessKeyId:process.env.aws_access_key_id,secretAccessKey:process.env.aws_secret_access_key}});router.post("/:document_id",function(e,s,n){const r=e.params.document_id;let t=JSON.parse(e.body);JSON.parse(t)&&(t=JSON.stringify(JSON.parse(t),null,2));const o=`documents/${r}.json`;fs.writeFile(o,t,function(e){if(e)return console.log(e);if("prod"===process.env.environment){const e={localFile:o,s3Params:{Bucket:"static.everything.io",Key:`permy.link/${o}`}},n=s3_client.uploadFile(e);n.on("error",function(e){s.status(500).send(e)}),n.on("end",function(){s.send(`Saved ${t} as ${r}.json`)})}else s.send(`Saved ${t} as ${r}.json`)})}),router.get("/:document_id/raw",function(e,s,n){const r=e.params.document_id,t=`documents/${r}.json`;"prod"===process.env.environment?s.redirect(`http://static.everything.io.s3-website-us-east-1.amazonaws.com/permy.link/${t}`):fs.readFile(t,"utf8",(e,n)=>{if(e)return void console.error(e);s.setHeader("Content-Type","application/json");const r=JSON.stringify(JSON.parse(n),null,2);s.send(r)})}),router.get("/:document_id",function(e,s,n){const r=e.params.document_id,t=`documents/${r}.json`;"prod"===process.env.environment?s.redirect(`http://static.everything.io.s3-website-us-east-1.amazonaws.com/permy.link/${t}`):fs.readFile(t,"utf8",(e,n)=>{if(e)return console.error(e),void s.status(500).send(e);try{s.send(n)}catch(e){s.status(500).send(e)}})}),module.exports=router;